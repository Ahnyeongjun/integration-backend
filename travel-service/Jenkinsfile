pipeline {
    agent any
    
    environment {
        SERVICE_NAME = 'travel-service'
        NEXUS_HOST = '100.86.217.36'
        NEXUS_PORT = '30500'
        DOCKER_REGISTRY = "${NEXUS_HOST}:${NEXUS_PORT}"
        DOCKER_IMAGE = "${DOCKER_REGISTRY}/${SERVICE_NAME}"
        K8S_NAMESPACE = 'msa-platform'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                dir("${SERVICE_NAME}") {
                    sh './gradlew clean build -x test'
                }
            }
        }
        
        stage('Test') {
            steps {
                dir("${SERVICE_NAME}") {
                    sh './gradlew test'
                }
            }
            post {
                always {
                    junit "${SERVICE_NAME}/build/test-results/test/*.xml"
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                dir("${SERVICE_NAME}") {
                    script {
                        docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                        docker.build("${DOCKER_IMAGE}:latest")
                    }
                }
            }
        }
        
        stage('Docker Push') {
            steps {
                script {
                    sh "docker push ${DOCKER_IMAGE}:${BUILD_NUMBER}"
                    sh "docker push ${DOCKER_IMAGE}:latest"
                }
            }
        }
        
        stage('Deploy to K8s') {
            steps {
                withKubeConfig([credentialsId: 'kubeconfig']) {
                    sh """
                        kubectl set image deployment/${SERVICE_NAME}                             ${SERVICE_NAME}=${DOCKER_IMAGE}:${BUILD_NUMBER}                             -n ${K8S_NAMESPACE}
                        kubectl rollout status deployment/${SERVICE_NAME} -n ${K8S_NAMESPACE}
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "Pipeline succeeded for ${SERVICE_NAME}"
        }
        failure {
            echo "Pipeline failed for ${SERVICE_NAME}"
        }
    }
}
